<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- Apple Support -->
    <meta name="apple-mobile-web-app-title" content="FFBExecute">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width">

    <link rel="apple-touch-icon" sizes="180x180" href="/ffbe/resource/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/ffbe/resource/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/ffbe/resource/favicon-16x16.png">
    <link rel="manifest" href="/ffbe/resource/site.webmanifest">
    <link rel="mask-icon" href="/ffbe/resource/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/ffbe/resource/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/ffbe/resource/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <title>FFBExecute - Web Interface</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script type="text/javascript" src="http://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

    <script type="text/javascript">
        $(function(){

            var device = $('#device');
            var view = $('#view');
            var view2 = $('#view2');
            var script = $('#script');
            var script2 = $('#script2');
            var statusName = $('#statusName');

            var logs = $('#logs');
            var states = $('#states');
            var components = $('#components');

            var playerLevel = $('#player-level');
            var deviceIp = $('#device-ip');

            var playPauseButton = $('#controlPlayPause');
            var unloadButton = $('#controlUnload');
            var loadButton = $('#controlLoad');

            var controlPlayerSave = $('#controlPlayerSave');
            var controlDeviceSave = $('#controlDeviceSave');

            var settingForm = $('#setting-form');
            var playerForm = $('#player-form');
            var variableForm = $('#variable-form');
            var variableContainer = $('#variable-container');
            var loadedForm = $('#loaded-form');

            var controlAdb = $('.controlAdb');
            var adbInfo = $('#adb-info');
            var linkedVariables = {};

            var notWhileRunning = $('.notWhileRunning');

            var logItems = [];

            function populateSelect(select, items) {
                var i = 0;
                select.empty();
                for (i = 0; i < items.length; i++) {
                    select.append($('<option></option>').text(items[i]).attr('value', items[i]));
                }
            }

            view.change(function(){
                view2.prop('disabled', !view.val());
            });

            script.change(function(){
                script2.prop('disabled', !script.val());
            });

            function createGroup(name, field, button) {
                var grp = $('<div class="input-group mb-3"></div>').appendTo(variableContainer);
                $('<div class="input-group-prepend"></div>').append($('<span class="input-group-text" id=""></span>').text(name)).appendTo(grp);
                field.appendTo(grp);
                $('<div class="input-group-append"></div>').append(button).appendTo(grp);
                return grp;
            }

            function statusCheck() {
                $.getJSON({
                    url: '/ffbe/status',
                    data: {},
                    success: function(data){

                        var i = 0, item, div;

                        statusName.text(data.status);

                        switch(data.status) {
                            case 'INIT': {
                                playPauseButton.addClass('disabled');
                                unloadButton.addClass('disabled');
                                settingForm.show();
                                loadedForm.hide();
                                states.prop('disabled', true);
                            } break;
                            case 'READY': {
                                playPauseButton.removeClass('disabled');
                                unloadButton.removeClass('disabled');
                                settingForm.hide();
                                loadedForm.show();
                                states.prop('disabled', false);
                                notWhileRunning.prop('disabled', false);
                            } break;
                            case 'RUNNING':
                            case 'STOPPED': {
                                playPauseButton.removeClass('disabled');
                                unloadButton.removeClass('disabled');
                                settingForm.hide();
                                loadedForm.show();
                                states.prop('disabled', true);
                                notWhileRunning.prop('disabled', true);
                                setTimeout(statusCheck, 3000);
                            } break;
                        }

                        if (data.state) {
                            states.val(data.state);
                        }

                        for (i = 0; i < data.logs.length; i++) {
                            item = data.logs[i];
                            div = $('<div class="row"></div>')
                            div.append($('<div class="col-sm-2 col-md-2 d-none d-sm-block"></div>').text(item.source));
                            div.append($('<div class="col-sm-4 col-md-2"></div>').text(item.timestamp));
                            div.append($('<div class="col-sm-2 col-md-2 d-none d-sm-block"></div>').text(item.level));
                            div.append($('<div class="col-sm-8 col-md-6"></div>').text(item.message));
                            logItems.push(div);
                            logs.prepend(div);
                        }

                        while (logItems.length > 50) {
                            logItems.splice(0,1)[0].detach();
                        }

                        if (data.variables.length > 0) {
                            for (i = 0; i < data.variables.length; i++) {
                                item = data.variables[i];
                                linkedVariables[item.name].val(formatVariable(item));
                            }
                        }

                    }
                });
            }

            playPauseButton.click(function(){
                if (!playPauseButton.hasClass('disabled')) {
                    $.ajax({
                      type: "POST",
                      url: '/ffbe/process/playPause/' + states.val(),
                      success: function(result){
                        statusCheck();
                      }
                    });
                }
            });

            unloadButton.click(function(){
                if (!unloadButton.hasClass('disabled')) {
                    $.ajax({
                      type: "POST",
                      url: '/ffbe/process/unload',
                      success: function(result){
                        statusCheck();
                      }
                    });
                }
            });

            controlPlayerSave.click(function(){
                $.ajax({
                  type: "POST",
                  url: '/ffbe/player/level',
                  data: {value: playerLevel.val()}
                });
            });

            controlAdb.click(function(){
                $.ajax({
                    type: "POST",
                    url: '/ffbe/adb/' + $(this).attr('adb'),
                    data: {},
                    success: function(result){
                        adbInfo.val(result.value);
                    }
                });
            });

            controlDeviceSave.click(function(){
                $.ajax({
                  type: "POST",
                  url: '/ffbe/device/ip',
                  data: {value: deviceIp.val()}
                });
            });

            $('.controlButton').click(function(){
                var ref= $(this), button = ref.attr('controlButton'), componentId = $('#components').val();
                $.ajax({
                    type: "POST",
                    url: '/ffbe/button',
                    data: {buttonId: button, componentId: componentId}
                });
            });

            function doubleWide(numb) {
                if (numb < 10) {
                    return "0" + numb;
                }
                return numb;
            }

            function formatVariable(varDef) {
                switch(varDef.displayType) {
                    case 'STANDARD':
                        return varDef.value;
                    case 'TENTH': {
                        return ((varDef.value - 0) / 10.0).toFixed(1) + "%";
                    } break;
                    case 'SECONDS': {
                        var total = varDef.value - 0;
                        var hours = Math.floor(total / (3600));
                        total -= (hours * 3600);
                        var minutes = Math.floor(total / 60);
                        var seconds = total % 60;
                        return doubleWide(hours) + ":" + doubleWide(minutes) + ":" + doubleWide(seconds);
                    } break;
                }
            }

            function loadProcessInfo() {
                $.ajax({
                  type: "GET",
                  url: '/ffbe/process/info',
                  success: function(result){
                    if (result.status == 'OK') {
                        states.empty();
                        components.empty();
                        var i, item, grp, label, input, button;
                        for (i = 0; i < result.states.length; i++) {
                        states.append($('<option></option>').attr('value', result.states[i].value).text(result.states[i].name));
                        }
                        for (i = 0; i < result.components.length; i++) {
                        components.append($('<option></option>').attr('value', result.components[i].value).text(result.components[i].name));
                        }
                        variableContainer.empty();
                        linkedVariables = {};
                        if (result.variables.length > 0) {
                            variableForm.show();
                            for (i = 0; i < result.variables.length; i++) {
                                item = result.variables[i];

                                grp = $('<div class="input-group mb-3"></div>').appendTo(variableContainer);

                                $('<div class="input-group-prepend"></div>').append($('<span class="input-group-text" id=""></span>').text(item.display)).appendTo(grp);

                                linkedVariables[item.name] = $('<input type="text" class="form-control notWhileRunning"/>').data('key', item.name).val(formatVariable(item)).attr('id', 'var_' + item.name).appendTo(grp);
                                switch(item.modify) {
                                    case 'EDITABLE': {
                                        $('<div class="input-group-append"></div>').append($('<button class="btn btn-secondary updateVariable notWhileRunning" type="button">Update</button>').data('key', item.name).attr('for', 'var_' + item.name)).appendTo(grp);
                                    } break;
                                }
                            }
                        } else {
                            variableForm.hide();
                        }
                    }
                  },
                  dataType: 'json'
                });
            }

            variableContainer.on('click', 'button.updateVariable', function(){
                var ref = $(this), key = ref.data('key'), input = linkedVariables[key];
                if (input.val() && (input.val() - 0) >= 0) {
                    $.ajax({
                      type: "POST",
                      url: '/ffbe/variable',
                      data: {key: key, value: input.val()}
                    });
                }
            });

            loadButton.click(function(){

                var blob = {
                    device: device.val(),
                    view: view.val(),
                    view2: view2.val(),
                    script: script.val(),
                    script2: script2.val(),
                };

                $.ajax({
                  type: "POST",
                  url: '/ffbe/process/prep',
                  data: JSON.stringify(blob),
                  headers: {
                        'Content-Type': 'application/json'
                    },
                  success: function(result){
                    if (result.status == 'OK') {
                        loadProcessInfo();
                        statusCheck();
                    }
                  },
                  dataType: 'json'
                });

            });

            function firstTimeLoad() {

                $.getJSON({
                  url: '/ffbe/settings/list',
                  data: {},
                  success: function(data){
                    populateSelect(device, data.devices || []);
                    populateSelect(view, data.views || []);
                    populateSelect(view2, data.views || []);
                    populateSelect(script, data.scripts || []);
                    populateSelect(script2, data.scripts || []);
                  }
                });

                $.getJSON({
                      url: '/ffbe/player/level',
                      data: {},
                      success: function(data){
                        playerLevel.val(data.value);
                        playerForm.show();
                      }
                  }
                );

                $.getJSON({
                      url: '/ffbe/device/ip',
                      data: {},
                      success: function(data){
                        deviceIp.val(data.value);
                      }
                  }
                );

                statusCheck();
                loadProcessInfo();
            }

            setTimeout(firstTimeLoad, 100);
        });

    </script>
</head>
<body>

<div class="container-fluid">

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#" id="statusName">CHECKING</a>
    </nav>

    <div class="row">
        <form id="setting-form" class="col-sm-4" style="display:none;">
            <h3>Loader</h3>

            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Device</span>
                </div>
                <select class="form-control" id="device"></select>
            </div>
            <br/>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Primary View</span>
                </div>
                <select class="form-control" id="view"></select>
            </div>
            <br/>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Extra View</span>
                </div>
                <select class="form-control" id="view2" disabled></select>
            </div>
            <br/>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Primary Script</span>
                </div>
                <select class="form-control" id="script"></select>
            </div>
            <br/>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Extra Script</span>
                </div>
                <select class="form-control" id="script2" disabled></select>
            </div>
            <br/>
            <div class="form-group">
                <button type="button" id="controlLoad" class="btn btn-primary">Load</button>
            </div>
        </form>
        <form id="loaded-form" class="col-sm-4" style="display:none;">
            <h3>Run</h3>
            <div class="form-group">
                <label for="states">State</label>
                <select id="states" class="form-control"></select>
            </div>
            <div class="form-group">
                <button type="button" id="controlPlayPause" class="btn btn-primary">Play/Pause</button>
                <button type="button" id="controlUnload" class="btn  btn-danger notWhileRunning">Unload</button>
            </div>
            <div class="form-group">
                <label for="view">Components</label>
                <select id="components" class="form-control notWhileRunning"></select>
            </div>
            <div class="form-group">
                <button type="button" id="controlTap" controlButton="TAP" class="btn btn-info notWhileRunning controlButton">Tap</button>
                <button type="button" id="controlSwipeUp" controlButton="SWIPE_UP" class="btn btn-info notWhileRunning controlButton">Up</button>
                <button type="button" id="controlSwipeRight" controlButton="SWIPE_RIGHT" class="btn btn-info notWhileRunning controlButton">Right</button>
                <button type="button" id="controlSwipeDown" controlButton="SWIPE_DOWN" class="btn btn-info notWhileRunning controlButton">Down</button>
                <button type="button" id="controlSwipeLeft" controlButton="SWIPE_LEFT" class="btn btn-info notWhileRunning controlButton">Left</button>
            </div>
        </form>
        <form id="player-form" class="col-sm-3 offset-sm-1" style="display:none;">

            <h3>Settings</h3>

            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Player Level</span>
                </div>
                <input type="number" class="form-control" id="player-level"/>
                <div class="input-group-append">
                    <button type="button" id="controlPlayerSave" class="btn btn-primary">Update</button>
                </div>
            </div>
            <br/>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Device I.P.</span>
                </div>
                <input class="form-control" id="device-ip"/>
                <div class="input-group-append">
                    <button type="button" id="controlDeviceSave" class="btn btn-primary">Update</button>
                </div>
            </div>
            <br/>

            <div class="form-group">
                <label for="adb-info">ADB</label>
                <textarea class="form-control" id="adb-info" rows="3"></textarea>
            </div>

            <div class="input-group">
                    <button type="button" class="btn controlAdb btn-info notWhileRunning" adb="restart">Restart</button>
                    <button type="button" class="btn controlAdb btn-info notWhileRunning" adb="usb">USB</button>
                    <button type="button" class="btn controlAdb btn-info notWhileRunning" adb="remote">Remote</button>
                    <button type="button" class="btn controlAdb btn-info notWhileRunning" adb="connect">Connect</button>
                    <button type="button" class="btn controlAdb btn-info notWhileRunning" adb="devices">Devices</button>
            </div>

        </form>
        <form id="variable-form"  class="col-sm-3 offset-sm-1" style="display:none;">
            <h3>Variables</h3>
            <div id="variable-container">


            </div>
        </form>
    </div>

</div>


<div id="logs" class="container-fluid">


</div>
</body>
</html>